---
title: "RUNBOOKS — 운영/장애/배포/되돌리기 플레이북"
inherits: "./PRD_MAIN.md"
version: 1.0.0
last_updated: 2025-10-25T00:00:00+09:00 # KST
owner: Ops-Owner-Name
status: draft
timezone: "Asia/Seoul"
audience: ["Admin(1인)", "PM", "Data", "Partner Ops"]
---

# 0) 목적
운영자가 **빠르고 일관되게** 핵심 업무(추첨 실행·대기자 승급·알림·AdGate·승인/정책 변경)를 수행하고,
장애 시 **안전하게 복구/우회/되돌리기** 하기 위한 표준 절차(SOP)를 문서화한다.

> 원칙  
> - **사전점검 → 실행 → 검증 → 기록/공지 → 되돌리기 경로 확보**  
> - 사용자 알림은 **조용한 시간(22:00–08:00 KST)** 준수

---

# 1) 연락/의사소통(간략)
- **주 담당**: Admin(1인)
- **백업**: PM
- **장애 방송 채널**: 내부 메신저 `#ops-incident`
- **외부 알림**: 공지 배너, 이메일 템플릿 `INCIDENT_NOTICE`

---

# 2) 표준 체크리스트(공통)
- [ ] 권한 확인(Admin 화이트리스트 + 2FA)
- [ ] 관련 정책값 확인(`PRD_MAIN.md: policy_defaults`)
- [ ] 영향 범위 파악(대상 캠페인/이벤트/파트너)
- [ ] 감사 로그 ON(행위 전후 스냅샷 기록)
- [ ] 되돌리기 포인트 생성(정책/데이터)

---

# 3) 추첨 실행 Runbook (Admin > Lottery)

## 3.1 사전점검
- [ ] 이벤트 상태 = **closed** 또는 **drawing_ready**
- [ ] 좌석 수(K) 확인
- [ ] **Intro-first / AdGate** 사전조건 통과율 확인
- [ ] 블랙리스트/의심 필터 ON
- [ ] 가중치 상한 = `policy_defaults.lottery.weight_cap`
- [ ] 시드 표시값 확인(`SHA256(campaignId + drawAt(KST) + serverSecret)`)

## 3.2 드라이런(미확정 미발송)
1. **미리보기**: 가중치 분포 히스토그램
2. **샘플 추출(테스트)**: seats=5 임시 실행(결과 확정 금지)
3. **감사 로그**: 파라미터 스냅샷 저장

## 3.3 본 실행
1. 2단계 확인 모달: 좌석수/시드/시간 재확인  
2. **실행** → 결과 확정(당첨/대기 분리)  
3. **CSV** 내보내기(보관)  
4. **알림 큐** 등록(조용한 시간 준수)

## 3.4 검증
- [ ] 결과 수량 = 좌석 수 + 대기자 수
- [ ] 동일 입력+시드 재실행 시 결과 일치(감사 리플레이)
- [ ] 알림 큐 적재 성공률 ≥ 98%

## 3.5 되돌리기
- **조건**: 정책/필터 오류, 좌석 수 오기 등
- 절차:
  1) `LotteryRun` 롤백 포인트로 복귀(감사 로그 참조)  
  2) 당첨/대기 상태 **무효화** → 재실행  
  3) 잘못 발송된 알림 **취소/정정 공지**(템플릿 `DRAW_ROLLBACK_NOTICE`)

---

# 4) 대기자 승급 Runbook

## 4.1 개요
- 트리거: 미응답/거절/만료
- 실행: 스케줄러(15분 간격) + 수동

## 4.2 절차
- [ ] 대상 이벤트 `drawing_done` 상태 확인
- [ ] 미응답 타임아웃 정책 확인(예: 24h)
- [ ] 승급 수 산정 → 상위 대기자 N명 승급
- [ ] 알림 큐 적재

## 4.3 점검
- [ ] 승급 결과가 **중복 당첨**을 만들지 않음
- [ ] `waitlist_promoted` 이벤트 생성
- [ ] 잔여 좌석=0 시 추가 승급 중단

---

# 5) AdGate 비상중지 Runbook

## 5.1 트리거 예시
- 스폰서 랜딩 장애, UTM 대량 누락, 검증 서버 오류, 오탐 급증

## 5.2 옵션
- **캠페인 단위**: 해당 캠페인의 AdGate 일시 **무시**(응모 허용)  
- **전역 단위**: `policies > AdGate` **Bypass 모드** ON, 배너 안내

## 5.3 절차(캠페인 단위 권장)
1. Admin > Policies: 해당 캠페인 **예외 플래그** ON  
2. 이벤트 상세에 **예외 사유/기간** 기록  
3. 공지 배너 노출: “일시적으로 스폰서 방문 검증을 면제합니다”  
4. Analytics: `adgate_verify_fail` 추이 모니터

## 5.4 복귀
- 원인 해소 후 예외 플래그 OFF
- 영향 기간 리포트 작성(AdGate 면제 건)

---

# 6) 알림 큐 Runbook

## 6.1 큐 상태 점검
- 대시보드 > 알림: 대기/성공/실패/재시도 수치
- 실패 Top `reason` 모니터

## 6.2 조용한 시간 처리
- 22:00–08:00 요청 → **Queued** 상태 유지
- 08:00 이후 **순차 발송**

## 6.3 대량 실패 처리
1. 발송 벤더 상태 점검
2. 큐 **Pause** → 설정값/템플릿 점검
3. 재시도 백오프 설정 재검토
4. 데드레터 큐 적재분 샘플링 → 원인 태깅

## 6.4 수동 재발송
- 조건: 템플릿 오류 수정 완료
- 대상 세그먼트 재선택 후 **Resend**  
- 중복 발송 방지 키 확인

---

# 7) 승인/검수 Runbook

## 7.1 파트너 승인
- 신청서 사실관계 확인 → 승인/반려  
- 반려 사유 템플릿 사용  
- 반복 반려 → 계정 제한 검토

## 7.2 작품 검수
- 필수 메타/미디어 규격 점검  
- 공개 후 **주요 필드** 변경 시 재검수 플래그 ON  
- 저작권·비속어 등 정책 위반 시 반려 + 증거 로그 첨부

## 7.3 이벤트 검수
- AdGate 규칙이 **정책 범위** 내인지 확인  
- 가중치 설정값 과도 편향 여부(상한/쿨다운) 점검

---

# 8) 정책 변경 Runbook (Admin > Policies)

## 8.1 사전점검
- [ ] 변경 이유·영향 분석 메모  
- [ ] 실험 여부 결정(전면/부분)

## 8.2 적용
1. 변경값 입력 → **2단계 확인**  
2. **롤백 포인트 생성**  
3. 즉시 적용(캐시 무결성 확인)

## 8.3 검증
- 30–60분 모니터링: 퍼널/오류율  
- 임계 초과 시 롤백

## 8.4 롤백
- 변경 이력에서 선택 → **Rollback**  
- 영향 보고서 기록

---

# 9) Kakao 인증 장애 Runbook

## 9.1 증상
- 로그인 실패 급증, 동의창 진입 불가, 콜백 오류

## 9.2 즉시 조치
- 상태 페이지/벤더 공지 확인  
- **열람 퍼널**은 열어두되 **응모는 로그인 필수** 유지(보안)  
- 장애 배너: “카카오 로그인 장애로 응모가 지연될 수 있습니다”

## 9.3 복구 후
- 실패 세션 안내 재시도 배너  
- 인증 실패 로그/시간대 보고

---

# 10) Admin 2FA 유실/접근 장애 Runbook

## 10.1 시나리오
- 기기 분실, OTP 재설정 필요

## 10.2 절차
1. 백업 코드 확인(보관 장소)  
2. 백업 코드 불가 → PM 공동 승인으로 **2FA 초기화**  
3. 초기화는 감사 로그에 기록

---

# 11) 데이터 수정/정정 Runbook

## 11.1 중복 응모 정정
- 키: `(campaignId, kakaoUserId)`  
- 중복 레코드 **무효화 플래그** 처리  
- 정정 후 퍼널/리포트 재집계

## 11.2 가중치 재계산
- 정책값 변경 시 **새 제출분만** 반영(원칙)  
- 예외: 명백한 버그 → Admin 승인 하에 일괄 재계산, 감사 로그 기록

---

# 12) 분석/품질 Runbook

## 12.1 일일 점검(09:30)
- 전일 퍼널, `adgate_verify_fail%`, `entry_precondition%`, 조용한 시간 위반=0  
- 수집 유실 < 0.1%

## 12.2 릴리스 전 태깅 샷건
- 핵심 시나리오 전부 클릭 테스트 → 이벤트 존재 확인  
- 대시보드 쿼리와 샘플 합계 매칭

---

# 13) 장애 분류(예시)

| SEV | 정의               | 예시                      | 초기 대응 |
|-----|--------------------|---------------------------|-----------|
| 1   | 전면 중단          | 로그인/응모 불가          | 배너+우회 |
| 2   | 주요 기능 저하     | AdGate 대량 실패          | 예외 플래그|
| 3   | 일부 오류/지연     | 알림 실패 상승            | 큐 점검   |

---

# 14) 공지 템플릿(요약)

## 14.1 장애 공지
- 제목: `[안내] 시스템 점검/장애 안내 (KST 시각)`  
- 본문: 영향 기능, 기간, 조치, 재시도 안내

## 14.2 추첨 결과 정정
- 제목: `[중요] 추첨 결과 정정 안내`  
- 본문: 정정 사유, 되돌리기 조치, 이용자 권리/보상

---

# 15) 주기 작업(스케줄)

| 작업                        | 주기     | 담당 |
|----------------------------|----------|-----|
| 대기자 승급 스케줄러       | 15분     | Admin |
| 알림 큐 지표 점검          | 30분     | Admin |
| 퍼널/광고/AdGate 리포트    | 매일 09:30| Data |
| 정책 변경 이력 백업        | 매일 03:00| Ops  |

---

# 16) 사전점검/출시 체크리스트

- [ ] 정책값/롤백포인트 확인  
- [ ] 퍼널 임계 경보 설정 활성  
- [ ] 알림 큐 동작 테스트  
- [ ] 감사 로그 쓰기 정상  
- [ ] 배너/공지 템플릿 준비

---

# 17) 부록: 커맨드/의사코드(예시)

## 17.1 추첨(무교체 가중 샘플링)
```pseudo
seed = SHA256(campaignId + drawAtKST + secret)
setRandomSeed(seed)
W = [{userId, w}]  # 필터링 완료
w' = max(w, 1e-9)
key = -ln(U)/w'
pick K smallest(key)
